name: Performance Test Pipeline

on:
  workflow_dispatch:
    inputs:
      aut_repo:
        description: 'URL del repositorio pÃºblico de la aplicaciÃ³n bajo prueba (PetStore)'
        required: true
        default: 'https://github.com/swagger-api/swagger-petstore.git'

      jmx_file:
        description: 'Nombre del archivo .jmx de JMeter'
        required: true
        default: 'PP_PetStoreApi.jmx'

jobs:
  performance_run:
    runs-on: ubuntu-24.04

    steps:
      - name: âš™ï¸ Checkout del Robot (Este Repositorio)
        uses: actions/checkout@v4

      - name: ğŸ“¦ Instalar Maven y Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ“¦ Instalar sysstat (para sar)
        run: sudo apt update && sudo apt install sysstat -y

      - name: ğŸ“¦ Instalar JMeter (Desde Repositorio Oficial)
        run: |
          JMETER_VERSION=5.6.3
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.zip
          unzip apache-jmeter-${JMETER_VERSION}.zip
          echo "$PWD/apache-jmeter-${JMETER_VERSION}/bin" >> $GITHUB_PATH

      - name: ğŸ“¦ Instalar dependencias de Python para el Reporte
        run: pip install pandas matplotlib plotly

      - name: ğŸ“¥ Clonar y compilar la AUT
        run: |
          git clone ${{ github.event.inputs.aut_repo }} aut_repo
          cd aut_repo

      - name: ğŸš€ Ejecutar la AUT en segundo plano
        run: |
          cd aut_repo
          mvn package jetty:run & 
          sleep 20
          cd ..


      - name: ğŸƒ Ejecutar Pruebas de Carga y Monitoreo de sar (Combinado)
        run: |
          # ----------------------------------------------------
          # INICIO: ARRANQUE DEL MONITOREO (SAR)
          # ----------------------------------------------------
          echo "Iniciando monitoreo sar..."
          
          # 1. Ejecutar sar en background, y capturar el PID inmediatamente despuÃ©s.
          # Usamos un sub-shell para asegurar que $! contenga el PID de sar.
          ( sar -o sar.bin -A 5 0 > /dev/null 2>&1 & echo $! > sar_pid_tmp.txt )
          
          # Dar tiempo a sar para iniciar y que el archivo PID se escriba
          sleep 2 
          
          # 2. Leer el PID capturado para usarlo en la terminaciÃ³n
          SAR_PID=$(cat sar_pid_tmp.txt)
          echo "sar iniciado con PID: $SAR_PID"

      - name: ğŸƒ Ejecutar Pruebas de Carga con JMeter
        run: |
          jmeter -n -t ${{ github.event.inputs.jmx_file }} \
                 -l results/jmeter_raw_results.jtl \
                 -e -o results/jmeter_html_report
          
          # ----------------------------------------------------
          # FINAL: DETENCIÃ“N Y CONVERSIÃ“N (SAR)
          # ----------------------------------------------------
          echo "Deteniendo sar y convirtiendo mÃ©tricas..."
          
          # Verificar si el PID es vÃ¡lido antes de llamar a kill
          if [[ -n "$SAR_PID" && "$SAR_PID" =~ ^[0-9]+$ ]]; then
            echo "Intentando detener sar con PID: $SAR_PID"
          
            # Detener el proceso sar de forma suave
            kill -15 "$SAR_PID"
            sleep 5 # Dar tiempo a sar para volcar los datos al disco
          
            # Limpieza final: forzar la muerte del proceso (silenciosamente)
            kill -9 "$SAR_PID" 2>/dev/null || true
          else
            echo "âš ï¸ ERROR FATAL: PID de sar no vÃ¡lido o vacÃ­o. No se pudo detener el monitoreo."
          fi

          # Convertir el archivo binario sar.bin a CSV (independientemente si el kill funcionÃ³)
          if [ -f sar.bin ]; then
            sadf -d sar.bin -- -A > sar_metrics.csv
            echo "MÃ©tricas de sar guardadas en sar_metrics.csv."
          else
            echo "âš ï¸ ADVERTENCIA: Archivo sar.bin no encontrado. sar_metrics.csv estarÃ¡ vacÃ­o."
            touch sar_metrics.csv
          fi

      - name: ğŸ Generar Reporte Combinado (Python)
        id: generate_report
        run: python generate_report.py

      - name: ğŸ“¤ Subir Reporte Combinado (HTML)
        uses: actions/upload-artifact@v4
        with:
          name: reporte-rendimiento-combinado
          path: combined_report.html

      - name: ğŸ“¤ Subir Archivos Crudos de JMeter
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-raw-data
          path: results/jmeter_raw_results.jtl

      - name: ğŸ“¤ Subir Reporte HTML Nativo de JMeter
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-native-report
          path: results/jmeter_html_report/

      - name: ğŸ“¤ Subir MÃ©tricas Crudas de sar (CSV)
        uses: actions/upload-artifact@v4
        with:
          name: sar-raw-data
          path: sar_metrics.csv