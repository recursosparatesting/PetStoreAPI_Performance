name: Performance Test Pipeline

on:
  workflow_dispatch:
    inputs:
      aut_repo:
        description: 'URL del repositorio p煤blico de la aplicaci贸n bajo prueba (PetStore)'
        required: true
        default: 'https://github.com/swagger-api/swagger-petstore.git'

      jmx_file:
        description: 'Nombre del archivo .jmx de JMeter'
        required: true
        default: 'PP_PetStoreApi.jmx'

jobs:
  performance_run:
    runs-on: ubuntu-24.04

    steps:
      - name: 锔 Checkout del Robot (Este Repositorio)
        uses: actions/checkout@v4

      - name:  Instalar Maven y Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name:  Instalar JMeter (Desde Repositorio Oficial)
        id: install_jmeter
        run: |
            JMETER_VERSION=5.6.3
            JMETER_ARCHIVE=apache-jmeter-${JMETER_VERSION}.zip
            JMETER_FOLDER=apache-jmeter-${JMETER_VERSION}
            
            echo "Descargando JMeter versi贸n ${JMETER_VERSION}..."
            wget https://archive.apache.org/dist/jmeter/binaries/${JMETER_ARCHIVE}
            unzip ${JMETER_ARCHIVE}
            
            # Definir JMETER_HOME para uso posterior
            JMETER_HOME="$PWD/${JMETER_FOLDER}"
            echo "JMETER_HOME=${JMETER_HOME}" >> $GITHUB_ENV
            
            # Agregar el binario a GITHUB_PATH para que el comando 'jmeter' est茅 disponible
            echo "${JMETER_HOME}/bin" >> $GITHUB_PATH

      - name:  Clonar y compilar la AUT
        run: |
          git clone ${{ github.event.inputs.aut_repo }} aut_repo

      - name:  Ejecutar la AUT en segundo plano
        run: |
            # El 'mvn package jetty:run' inicia el servidor en segundo plano
            cd aut_repo
            nohup mvn package jetty:run &> aut.log &
            cd ..
            echo "La AUT se est谩 iniciando en segundo plano. Esperando..."

      - name: 憋 Esperar a que la AUT est茅 disponible (Health Check)
        uses: nev7n/wait_for_response@v1
        with:
                # URL por defecto de la aplicaci贸n PetStore con Jetty
                url: http://localhost:8080/swagger-petstore/v2/swagger.json
                # Espera hasta 180 segundos antes de fallar
                timeout: 360
                # Reintenta cada 5 segundos
                interval: 10
                # C贸digo HTTP esperado (200 OK)
                response_code: 200


      - name:  Ejecutar Pruebas de Carga con JMeter
        run: |
            # Asegurarse de que el directorio de resultados existe
            mkdir -p results
            
            # La variable de entorno JMETER_HOME est谩 disponible gracias al paso anterior
            # Ejecutamos jmeter.sh usando la ruta completa
            $JMETER_HOME/bin/jmeter.sh -n -t ${{ github.event.inputs.jmx_file }} \
                   -l results/jmeter_raw_results.jtl \
                   -e -o results/jmeter_html_report
          
      - name:  Subir Archivos Crudos de JMeter
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-raw-data
          path: results/jmeter_raw_results.jtl

      - name:  Subir Reporte HTML Nativo de JMeter
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-native-report
          path: results/jmeter_html_report/
